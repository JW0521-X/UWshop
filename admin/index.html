<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>U.W Admin</title>

<style>
body{
  background:#0b1020;
  color:#fff;
  font-family:system-ui;
  padding:1rem;
}
button{
  margin:0.2rem;
  padding:6px 10px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
input{
  padding:6px;
  margin:0.2rem;
}
.card{
  background:#1a1f3a;
  padding:1rem;
  border-radius:10px;
  margin-bottom:1rem;
}
.danger{
  background:#8b0000;
  color:#fff;
}
</style>
</head>

<body>

<h1>ğŸ›  U.W Admin</h1>

<form id="loginForm">
  <input type="password" id="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼">
  <button>ç™»å…¥</button>
</form>

<div id="adminPanel" style="display:none">

<!-- OG LOG -->
<h2>ğŸ§¾ Operation Log</h2>
<pre id="og" style="background:#000;padding:10px;height:150px;overflow:auto"></pre>

<!-- ç¶­è­·æ¨¡å¼ -->
<div class="card">
  <label>
    <input type="checkbox" id="maintenanceToggle">
    å•Ÿç”¨ç¶­è­·æ¨¡å¼ï¼ˆå‰å°æœƒè¢«æ“‹ï¼‰
  </label>
</div>

<!-- æ–°å¢å•†å“ -->
<div class="card">
  <h3>â• æ–°å¢å•†å“</h3>
  <input id="newName" placeholder="åç¨±">
  <input id="newPrice" type="number" placeholder="åƒ¹æ ¼">
  <input id="newNote" placeholder="å‚™è¨»">
  <input id="newContact" placeholder="è¯çµ¡æ–¹å¼" value="xxxx">
  <br>
  <button id="addBtn">æ–°å¢</button>
</div>

<!-- å•†å“åˆ—è¡¨ -->
<div id="adminProducts"></div>

<!-- Factory Reset -->
<div class="card">
  <button id="factoryResetBtn" class="danger">
    âš ï¸ æ¢å¾©å‡ºå» ï¼ˆæ¸…ç©ºæ‰€æœ‰å•†å“ï¼‰
  </button>
</div>

<div id="announcementControl" style="margin-bottom:1rem;">
  <h3>å…¬å‘Šæ¿æ§åˆ¶</h3>
  <input type="text" id="announcementInput" placeholder="è¼¸å…¥å…¬å‘Šæ–‡å­—" style="width:300px;">
  <button id="announcementBtn">æ›´æ–°å…¬å‘Š</button>
</div>

</div>

<script>
document.getElementById("announcementBtn").addEventListener("click", async ()=>{
  const text = document.getElementById("announcementInput").value.trim();
  if(!text) return alert("è«‹è¼¸å…¥å…¬å‘Šæ–‡å­—");
  try {
    const res = await fetch("/api/announcement",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    alert(data.message);
    document.getElementById("announcementInput").value="";
  } catch(err){
    alert("å…¬å‘Šæ›´æ–°å¤±æ•—ï¼š"+err);
  }
});
</script>


<script>
const PASSWORD = "1346";
let products = [];

const loginForm = document.getElementById("loginForm");
const adminPanel = document.getElementById("adminPanel");

loginForm.onsubmit = e => {
  e.preventDefault();
  if(password.value === PASSWORD){
    loginForm.style.display="none";
    adminPanel.style.display="block";
    loadProducts();
    loadMaintenance();
    loadLogs();
  } else alert("å¯†ç¢¼éŒ¯èª¤");
};

// ===== å•†å“ =====
async function loadProducts(){
  const res = await fetch("/api/products");
  products = await res.json();
  renderProducts();
}

function renderProducts(){
  const box = document.getElementById("adminProducts");
  box.innerHTML = "<h2>ğŸ“¦ å•†å“</h2>";
  products.forEach((p,i)=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <b>${p.name}</b>ï¼ˆ${p.status}ï¼‰<br>
      <button onclick="setStatus(${i},'available')">å¯è³¼è²·</button>
      <button onclick="setStatus(${i},'reserved')">æ´½è«‡ä¸­</button>
      <button onclick="setStatus(${i},'sold')">å·²å”®</button>
      <button onclick="setStatus(${i},'hidden')">ä¸‹æ¶</button>
      <button class="danger" onclick="removeProduct(${i})">åˆªé™¤</button>
    `;
    box.appendChild(div);
  });
}

function setStatus(i,status){
  fetch(`/api/products/${products[i].id}/status`,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({status})
  }).then(()=>{products[i].status=status;renderProducts();});
}

function removeProduct(i){
  if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ"))return;
  fetch(`/api/products/${products[i].id}`,{method:"DELETE"})
    .then(()=>{products.splice(i,1);renderProducts();});
}

// æ–°å¢
addBtn.onclick = async ()=>{
  const p={
    id:Date.now()+"",
    name:newName.value,
    price:+newPrice.value,
    note:newNote.value,
    contact:newContact.value,
    status:"available"
  };
  await fetch("/api/products",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
  products.push(p);
  renderProducts();
};

// ===== ç¶­è­· =====
async function loadMaintenance(){
  const r = await fetch("/api/maintenance");
  const d = await r.json();
  maintenanceToggle.checked = d.maintenance;
}
maintenanceToggle.onchange = ()=>{
  fetch("/api/maintenance",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({maintenance:maintenanceToggle.checked})});
};

// ===== Factory Reset =====
factoryResetBtn.onclick = async ()=>{
  if(!confirm("âš ï¸ æœƒåˆªé™¤å…¨éƒ¨å•†å“"))return;
  if(!confirm("â— æœ€å¾Œç¢ºèª"))return;
  await fetch("/api/factory-reset",{method:"POST"});
  products=[];
  renderProducts();
  maintenanceToggle.checked=false;
};

// ===== OG LOG =====
async function loadLogs(){
  const r = await fetch("/api/logs");
  const logs = await r.json();
  og.textContent = logs.join("\n");
}
setInterval(loadLogs,3000);
</script>

</body>
</html>

