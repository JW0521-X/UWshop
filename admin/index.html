<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>U.W Admin</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0b1020;
  color:white;
}
header{
  background:#1a1f3a;
  padding:1rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}
button.danger{
  background:#ef4444;
  color:white;
}
input{
  padding:6px;
  margin:0.2rem;
}
.card{
  background:#1a1f3a;
  padding:1rem;
  border-radius:10px;
  margin-bottom:1rem;
}
.container{
  padding:1rem 2rem;
}
</style>
</head>

<body>

<header>
  <h2>ğŸ›  U.W Admin</h2>
  <div>
    <span id="adminName"></span>
    <button onclick="logout()" class="danger">ç™»å‡º</button>
  </div>
</header>

<div class="container">

  <!-- ç®¡ç†å“¡è³‡è¨Š -->
  <div class="card">
    <h3>ğŸ‘¤ ç®¡ç†å“¡è³‡è¨Š</h3>
    <p>å¸³è™Ÿï¼š<span id="adminAccount"></span></p>
    <p>è§’è‰²ï¼š<span id="adminRole"></span></p>
  </div>

  <!-- ç¶­è­·æ¨¡å¼ -->
  <div class="card">
    <h3>ğŸ”§ ç¶­è­·æ¨¡å¼</h3>
    <label><input type="checkbox" id="maintenanceToggle"> å•Ÿç”¨ç¶­è­·æ¨¡å¼</label>
  </div>

  <!-- æ–°å¢å•†å“ -->
  <div class="card">
    <h3>â• æ–°å¢å•†å“</h3>
    <input id="newName" placeholder="åç¨±">
    <input id="newPrice" type="number" placeholder="åƒ¹æ ¼">
    <input id="newNote" placeholder="å‚™è¨»">
    <input id="newContact" placeholder="è¯çµ¡æ–¹å¼">
    <br>
    <button id="addBtn">æ–°å¢å•†å“</button>
  </div>

  <!-- å•†å“åˆ—è¡¨ -->
  <div class="card">
    <h3>ğŸ“¦ å•†å“åˆ—è¡¨</h3>
    <div id="adminProducts"></div>
  </div>

  <!-- Factory Reset -->
  <div class="card">
    <button id="factoryResetBtn" class="danger">âš ï¸ æ¸…ç©ºæ‰€æœ‰å•†å“</button>
  </div>

  <!-- å…¬å‘Š -->
  <div class="card">
    <h3>ğŸ“¢ å…¬å‘Šæ¿æ§åˆ¶</h3>
    <input type="text" id="announcementInput" placeholder="å…¬å‘Šæ–‡å­—" style="width:300px;">
    <button id="announcementBtn">æ›´æ–°å…¬å‘Š</button>
  </div>

  <!-- Logs -->
  <div class="card">
    <h3>ğŸ§¾ Operation Log</h3>
    <pre id="og" style="background:#000;padding:10px;height:150px;overflow:auto"></pre>
  </div>

</div>

<script>
const token = localStorage.getItem("token");
if(!token){
  window.location.href="/login.html";
}

/* ===== é©—è­‰ admin ===== */
fetch("/api/users/me", {
  headers: { "Authorization":"Bearer " + token }
})
.then(res=>res.json())
.then(user=>{
  if(user.role!=="admin"){
    alert("ä½ ä¸æ˜¯ç®¡ç†å“¡");
    window.location.href="/index.html";
    return;
  }
  document.getElementById("adminName").textContent = "ğŸ‘¤ " + user.username;
  document.getElementById("adminAccount").textContent = user.username;
  document.getElementById("adminRole").textContent = user.role;
})
.catch(()=>{
  localStorage.removeItem("token");
  window.location.href="/login.html";
});

/* ===== ç™»å‡º ===== */
function logout(){
  localStorage.removeItem("token");
  window.location.href="/login.html";
}

/* ===== ç¶­è­·æ¨¡å¼ ===== */
const maintenanceToggle = document.getElementById("maintenanceToggle");
function loadMaintenance(){
  fetch("/api/maintenance", { headers:{ "Authorization":"Bearer "+token }})
    .then(r=>r.json())
    .then(d=>{maintenanceToggle.checked=d.maintenance;});
}
maintenanceToggle.onchange = ()=>{
  fetch("/api/maintenance",{
    method:"POST",
    headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
    body: JSON.stringify({ maintenance: maintenanceToggle.checked })
  });
}
loadMaintenance();

/* ===== å•†å“ç®¡ç† ===== */
let products = [];
function loadProducts(){
  fetch("/api/products", { headers:{ "Authorization":"Bearer "+token }})
    .then(r=>r.json())
    .then(d=>{products=d; renderProducts();});
}
function renderProducts(){
  const box = document.getElementById("adminProducts");
  box.innerHTML="";
  products.forEach((p,i)=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <b>${p.name}</b>ï¼ˆ${p.status || "available"}ï¼‰<br>
      <button onclick="setStatus(${i},'available')">å¯è³¼è²·</button>
      <button onclick="setStatus(${i},'reserved')">æ´½è«‡ä¸­</button>
      <button onclick="setStatus(${i},'sold')">å·²å”®</button>
      <button onclick="setStatus(${i},'hidden')">ä¸‹æ¶</button>
      <button class="danger" onclick="removeProduct(${i})">åˆªé™¤</button>
    `;
    box.appendChild(div);
  });
}
function setStatus(i,status){
  fetch(`/api/products/${products[i].id}/status`,{
    method:"POST",
    headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
    body: JSON.stringify({ status })
  }).then(()=>{products[i].status=status; renderProducts();});
}
function removeProduct(i){
  if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ"))return;
  fetch(`/api/products/${products[i].id}`,{
    method:"DELETE",
    headers:{ "Authorization":"Bearer "+token }
  }).then(()=>{
    products.splice(i,1);
    renderProducts();
  });
}
document.getElementById("addBtn").onclick = ()=>{
  const p={
    id:Date.now()+"",
    name:document.getElementById("newName").value,
    price:+document.getElementById("newPrice").value,
    note:document.getElementById("newNote").value,
    contact:document.getElementById("newContact").value,
    status:"available"
  };
  fetch("/api/products",{
    method:"POST",
    headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
    body: JSON.stringify(p)
  }).then(()=>{products.push(p); renderProducts();});
}
document.getElementById("factoryResetBtn").onclick = ()=>{
  if(!confirm("âš ï¸ æœƒåˆªé™¤å…¨éƒ¨å•†å“")) return;
  fetch("/api/factory-reset",{
    method:"POST",
    headers:{ "Authorization":"Bearer "+token }
  }).then(()=>{products=[]; renderProducts(); maintenanceToggle.checked=false;});
}

/* ===== å…¬å‘Š ===== */
document.getElementById("announcementBtn").onclick = ()=>{
  const text = document.getElementById("announcementInput").value.trim();
  if(!text) return alert("è«‹è¼¸å…¥å…¬å‘Š");
  fetch("/api/announcement",{
    method:"POST",
    headers:{ "Content-Type":"application/json","Authorization":"Bearer "+token },
    body: JSON.stringify({ text })
  }).then(()=>{ alert("å…¬å‘Šå·²æ›´æ–°"); document.getElementById("announcementInput").value=""; });
}

/* ===== Logs ===== */
function loadLogs(){
  fetch("/api/logs",{ headers:{ "Authorization":"Bearer "+token }})
    .then(r=>r.json())
    .then(d=>{ document.getElementById("og").textContent=d.join("\n"); });
}
setInterval(loadLogs,3000);

/* ===== åˆå§‹åŒ– ===== */
loadProducts();

</script>

</body>
</html>
